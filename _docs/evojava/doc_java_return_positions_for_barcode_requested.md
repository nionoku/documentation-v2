---
title: Обработка события сканирования штрихкода
permalink: doc_java_return_positions_for_barcode_requested.html
sidebar: evojava
product: Java SDK
---

Когда пользователь сканирует штрихкод, смарт-терминал рассылает событие [`ReturnPositionsForBarcodeRequestedEvent`](./ссылка на javadoc).

Обрабатывая данные, содержащиеся в событии сканирования штрихкода, приложения могут добавлять позиции в чек продажи и / или создавать новые товары.

Схема распространения события сканирования штрихкода:

1. Пользователь сканирует штрихкод товара.
2. Смарт-терминал распространяет широковещательное сообщение и события.
3. Приложения подписанные на получение события выполняют поиск товара, на основе содержащихся в событии данных.

   Если на получение события подписано несколько приложений, смарт-терминал позволяет пользователю выбрать приложение, которое будет обрабатывать событие.

4. После обнаружения товара, выбранное приложение добавляет его в позицию чека продажи.

   Если приложение не может найти товар, оно может предложить пользователю создать новый товар. При этом будет вызван интерфейс смарт-терминала и товар будет создан в первую очередь в базе смарт-терминала.

5. Если приложение не находит товар и не предлагает пользователю создать карточку товара, событие вернётся в Evotor POS, который также попытается выполнить поиск товара или, в случае неудачи, создать новый товар.

## Разрешение на обработку события сканирования штрихкода

Для обработки события сканирования штрихкода, в манифесте приложения необходимо указать следующее разрешение:

```xml
<uses-permission android:name="ru.evotor.permission.SELL_INTEGRATION_SERVICE" />
```

## Получение события

Создайте службу, которая будет обрабатывать событие, например, `BarcodeEventHandlerService`.

В манифесте приложения, в разделе службы, укажите разрешение, а в intent-фильтре службы, укажите событие сканирования чека:

```xml
<service
    android:name=".BarcodeEventHandlerService"
    android:enabled="true"
    android:exported="true"
    android:permission="ru.evotor.permission.SELL_INTEGRATION_SERVICE">
    <!-- служба использует объявленное разрешение -->
    <intent-filter>
        <!-- событие сканирования штрихкода -->
        <action android:name="ru.evotor.event.sell.BARCODE_RECEIVED" />
        <category android:name="android.intent.category.EVOTOR" />
    </intent-filter>
</service>
```

## Обработка события

После сканирования штрихкода, служба получит событие `ReturnPositionsForBarcodeRequestedEvent`, которое содержит строку штрихкода (`barcode`) и параметр `creatingNewProduct` со значением `false`. С помощью параметра `creatingNewProduct` смарт-терминал сообщает приложениям о необходимости создания нового товара.

Получив событие, служба `BarcodeEventHandlerService` может добавить существующий товар в чек продажи или запустить процесс создания нового товара.

Чтобы обработать событие сканирования штрихкода:

1. Унаследуйте службу `BarcodeEventHandlerService` от службы [`SellIntegrationService`](./ссылка на javadoc).
2. Переопределите метод [`handleEvent()`](./) и передайте в него событие сканирования штрихкода [`ReturnPositionsForBarcodeRequestedEvent`](./).

   В методе следует реализовать логику поиска товаров по данным из события и наполнения списка позиций чека продажи.

   {% include note.html content="Наряду с приложениями, которые обрабатывают события сканирования штрихкода, смарт-терминал самостоятельно выполняет поиск товара. Если после обработки события будет найдено несколько товаров, или несколько различных приложений предложат свои результаты, пользователь сможет выбрать что добавить в чек." %}

4. Верните результат `ReturnPositionsForBarcodeRequestedEvent.Result()`.

   В результате приложение может вернуть одну или несколько позиций, которые будут добавлены в чек продажи. Кроме списка позиций, в результате необходимо вернуть параметр `iCanCreateNewProduct`. Параметр принимает значение `true` или `false` и указывает на то, может приложение создать новый товар или нет.

### Создание нового товара

Если приложение не нашло необходимый товар, но готово создать новый (результат обработки события содержит параметр `iCanCreateNewProduct == true`), смарт-терминал передаст приложению событие `ReturnPositionsForBarcodeRequestedEvent` с параметром `creatingNewProduct == true`. В ответ на это событие метод `handleEvent()` должен вернуть `null`.

{% include tip.html content="Для создания нового товара вы можете воспользоваться методами [`NavigationApi`](./)." %}

После создания товара приложение должно вернуть одну или несколько позиций, которые будут добавлены в чек продажи. Рекомендуется возвращать одну позицию, которая ссылается на созданный товар.

Если ни одно из приложений не готово создать новый товар, смарт-терминал самостоятельно запустит процесс создания нового товара.

## Пример

```kotlin
open class BarcodeEventHandlerService : SellIntegrationService() {

    override fun handleEvent(
            /*
                ReturnPositionsForBarcodeRequestedEvent(
                    val barcode: String, -- строка, содержащая штрихкод (датаматрикс, gs1, ean8, ean13 -- всё, что прилетит со сканера)
                    val creatingNewProduct: Boolean -- признак необходимости создания нового товара по полученному штрихкоду
                )
             */
            event: ReturnPositionsForBarcodeRequestedEvent
    ):
            /*
                ReturnPositionsForBarcodeRequestedEvent.Result(
                    val positions: List<Position>, -- список позиций для добавления в чек
                    val iCanCreateNewProduct: Boolean -- признак того, что интеграция может и хочет создать товар по полученному штрихкоду
                )
             */
            ReturnPositionsForBarcodeRequestedEvent.Result?
    {

        //Создаём список позиций, который будет возвращён в результате
        val positions = mutableListOf<Position>()

        //Запускаем операцию CreateProductActivity для создания новой карточки товара, если creatingNewProduct == true.
        if (event.creatingNewProduct) {
            startIntegrationActivity(Intent(this, CreateProductActivity::class.java).apply {
                putExtra("SCANNED_BARCODE", event.barcode)
            })
            return null
        } else {
            //Наполняем список позиций positions
        }
        return ReturnPositionsForBarcodeRequestedEvent.Result(positions, iCanCreateNewProduct = true)
    }
}
```

<!-- ## См. также

* [Обработка событий смарт-терминала](./doc_java_return_st_events_processing.html) -->



<!-- ## DRAFT

Эта функциональность предваряет глобальные изменения в API смарт-терминала.

В рамках этой задачи сделаны следующие изменения:

* Создан новый пакет framework.common, в котором будут храниться родительские классы необходимые для интеграций. В пакет добавлены:

   * интеграционная служба второй версии (IntegrationServiceV2). Чтобы поддержать заявленную функциональность, необходимо наследоваться от этой версии службы.
   * родительское событие IntegrationEvent.

* Добавлено событие ReturnPositionsForBarcodeRequestedEvent, унаследованное от IntegrationEvent.
* Добавлены две службы для обработки события: ReceiptFormationIntegrationService и SellIntegrationService. Обе службы унаследованы от IntegrationServiceV2.
* Изменён класс RequiresIntentAction. Теперь он необходим не только приёмникам широковещательных сообщений, но и для обработки событий смарт-терминала с помощью IntegrationServiceV2.


Для документирования понадобится:

* Добавить разел об обработке событий смарт-терминала с помощью интеграционных служб обоих версий.
* Обновить раздел doc_app_integration_points.html#events (дописать новое событие со ссылкой на javadoc).
* Обновить javadoc по созданным сущностям.
* Описать новое разрешение(?)


Начиная с версии Evotor POS X.X.X приложения могут добавлять позиции в чек продажи и создавать новые товары на основе данных, полученных от сканера штрихкодов.

Для этого в интеграционной библиотеке были созданы соответствующие интеграционные же службы. Вы можете видеть, что эти службы (наполнения чека и продажи) наследуют новую версию [интеграционной службы](./).

Таким образом механизм работы с новой функциональностью во многом напоминает обычную обработку [событий](./). -->
